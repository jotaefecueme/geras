<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GERAS</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>GERAS</h1>
        <h2>- Predicción de Edad y Género por Voz -</h2>
        <div class="button-group">
            <button id="recordButton">Grabar</button>
            <button id="stopButton" disabled>Detener</button>
        </div>
        <p id="status">Listo para grabar.</p>
        <div class="progress-container">
            <div id="progressBar"></div>
        </div>
        <p id="prediction"></p>
    </div>

    <script>
        let audioContext;
        let recorder;
        let audioBlob;
        let timeoutId;
        let startTime;
        const recordingDuration = 10000; // 10 segundos en milisegundos

        document.getElementById('recordButton').addEventListener('click', async () => {
            audioContext = new (window.AudioContext || window.webkitAudioContext)({sampleRate: 16000});
            const stream = await navigator.mediaDevices.getUserMedia({audio: true});
            const input = audioContext.createMediaStreamSource(stream);
            recorder = new MediaRecorder(stream, {mimeType: 'audio/webm'});

            let chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = async e => {
                audioBlob = new Blob(chunks, {type: 'audio/webm'});
                document.getElementById('stopButton').disabled = true;
                document.getElementById('recordButton').disabled = false;
                document.getElementById('status').innerText = 'Grabación detenida.';
                document.getElementById('progressBar').style.width = '0%';
                await sendAudio();
            };

            recorder.start();
            startTime = Date.now();
            document.getElementById('recordButton').disabled = true;
            document.getElementById('stopButton').disabled = false;
            document.getElementById('status').innerText = 'Grabando...';

            // Set a timeout to stop recording after 10 seconds
            timeoutId = setTimeout(() => {
                if (recorder.state !== 'inactive') {
                    recorder.stop();
                }
            }, recordingDuration);

            // Update progress bar
            updateProgressBar();
        });

        document.getElementById('stopButton').addEventListener('click', () => {
            clearTimeout(timeoutId);
            recorder.stop();
        });

        function updateProgressBar() {
            const intervalId = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min((elapsed / recordingDuration) * 100, 100);
                document.getElementById('progressBar').style.width = `${progress}%`;

                if (progress >= 100) {
                    clearInterval(intervalId);
                }
            }, 100);
        }

        async function sendAudio() {
            const formData = new FormData();
            formData.append('file', audioBlob, 'audio.webm');
            try {
                const response = await fetch('https://python-quality-fully.ngrok-free.app/predict', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                // Determine the gender with the highest probability
                const genderProbabilities = data.gender_probabilities;
                const genderEntries = Object.entries(genderProbabilities);
                const maxGender = genderEntries.reduce((max, entry) => entry[1] > max[1] ? entry : max, ['', 0]);

                document.getElementById('prediction').innerHTML = `
                    <div class="prediction-item">
                        <span class="prediction-title">Predicción de Edad:</span>
                        <span class="prediction-value">${data.age} años (${data.age_category})</span>
                    </div>
                    <div class="prediction-item">
                        <span class="prediction-title">Predicción de Género:</span>
                        <span class="prediction-value">${maxGender[0].charAt(0).toUpperCase() + maxGender[0].slice(1)}: ${maxGender[1].toFixed(2)}%</span>
                    </div>
                `;
            } catch (error) {
                document.getElementById('prediction').innerText = 'Error: ' + error.message;
            }
        }
    </script>
</body>
</html>
